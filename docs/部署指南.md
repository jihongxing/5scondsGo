# 5SecondsGo 部署指南

本文档详细说明如何部署 5SecondsGo 项目，包括服务器部署、Android/iOS 应用构建和发布。

## 目录

- [一、服务器部署](#一服务器部署)
- [二、Android 应用构建与发布](#二android-应用构建与发布)
- [三、iOS 应用构建与发布](#三ios-应用构建与发布)
- [四、管理后台部署](#四管理后台部署)
- [五、运维管理](#五运维管理)

---

## 一、服务器部署

### 1.1 服务器要求

| 配置项 | 最低要求 | 推荐配置 |
|--------|---------|---------|
| CPU | 2 核 | 4 核+ |
| 内存 | 4 GB | 8 GB+ |
| 硬盘 | 40 GB SSD | 100 GB SSD |
| 系统 | Ubuntu 20.04+ / CentOS 8+ | Ubuntu 22.04 LTS |
| 带宽 | 5 Mbps | 10 Mbps+ |

### 1.2 安装基础环境

#### 安装 Docker

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER

# 重新登录以使用户组生效
exit
# 重新 SSH 登录

# 验证安装
docker --version
```

#### 安装 Docker Compose

```bash
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

#### 安装 Nginx

```bash
sudo apt update
sudo apt install -y nginx certbot python3-certbot-nginx

# 启动 Nginx
sudo systemctl enable nginx
sudo systemctl start nginx
```

### 1.3 部署项目

#### 克隆代码

```bash
cd /opt
git clone https://github.com/jihongxing/5scondsGo.git
cd 5scondsGo
```

#### 配置环境变量

```bash
# 复制环境配置模板
cp .env.example .env

# 编辑配置文件
nano .env
```

`.env` 文件关键配置说明：

```bash
# ==================== 数据库配置 ====================
DB_USER=fiveseconds
DB_PASSWORD=your-secure-db-password    # 修改为强密码
DB_NAME=fiveseconds

# ==================== Redis 配置 ====================
REDIS_PASSWORD=your-secure-redis-password    # 修改为强密码

# ==================== JWT 配置 ====================
# JWT_SECRET 生成方法 (选择其一):
#
# 方法 1: 使用 OpenSSL (Linux/macOS)
#   openssl rand -base64 32
#
# 方法 2: 使用 PowerShell (Windows)
#   [Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 }) -as [byte[]])
#
# 方法 3: 使用 Python
#   python -c "import secrets; print(secrets.token_urlsafe(32))"
#
# 方法 4: 使用 Node.js
#   node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
#
JWT_SECRET=your-very-long-random-jwt-secret-key    # 必须修改为上述命令生成的值

# ==================== Grafana 配置 ====================
GRAFANA_USER=admin
GRAFANA_PASSWORD=your-grafana-password    # 修改为强密码
GRAFANA_ROOT_URL=https://monitor.your-domain.com

# ==================== 域名配置 ====================
API_DOMAIN=api.your-domain.com
ADMIN_DOMAIN=admin.your-domain.com
MONITOR_DOMAIN=monitor.your-domain.com
```

#### 启动服务

```bash
# 给部署脚本添加执行权限
chmod +x scripts/deploy.sh

# 检查配置
./scripts/deploy.sh check

# 构建 Docker 镜像
./scripts/deploy.sh build

# 启动所有服务
./scripts/deploy.sh start

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps
```

### 1.4 配置 Nginx 反向代理

#### 复制配置文件

```bash
sudo cp deploy/nginx/nginx.conf /etc/nginx/sites-available/fiveseconds
```

#### 修改域名配置

```bash
sudo nano /etc/nginx/sites-available/fiveseconds

# 将所有 your-domain.com 替换为你的实际域名
# 例如: api.your-domain.com → api.example.com
```

#### 启用站点配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/fiveseconds /etc/nginx/sites-enabled/

# 删除默认站点 (可选)
sudo rm /etc/nginx/sites-enabled/default

# 测试配置
sudo nginx -t

# 重载配置
sudo systemctl reload nginx
```

### 1.5 配置 SSL 证书

使用 Let's Encrypt 免费证书：

```bash
# 申请证书 (会自动修改 Nginx 配置)
sudo certbot --nginx -d api.your-domain.com -d admin.your-domain.com -d monitor.your-domain.com

# 按提示输入邮箱，同意条款

# 设置自动续期
sudo crontab -e
# 添加以下行:
0 0 1 * * /usr/bin/certbot renew --quiet
```

### 1.6 防火墙配置

```bash
# UFW 防火墙
sudo ufw allow 22/tcp      # SSH
sudo ufw allow 80/tcp      # HTTP
sudo ufw allow 443/tcp     # HTTPS
sudo ufw enable

# 或者使用 firewalld (CentOS)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 1.7 服务端口说明

| 服务 | 内部端口 | 外部访问 | 说明 |
|------|---------|---------|------|
| Go Server | 8080 | https://api.your-domain.com | API + WebSocket |
| Metrics | 9091 | 内部 | Prometheus 指标 |
| PostgreSQL | 5432 | 内部 | 数据库 |
| Redis | 6379 | 内部 | 缓存 |
| Grafana | 3000 | https://monitor.your-domain.com | 监控面板 |
| Prometheus | 9090 | 内部 | 指标收集 |
| Loki | 3100 | 内部 | 日志收集 |

### 1.8 Go 跨平台编译说明

由于本地开发环境是 Windows，而服务器是 Linux，需要了解 Go 的跨平台编译。

#### Docker 构建 (推荐)

使用 Docker 构建时，**无需手动处理跨平台问题**。Dockerfile 中已配置：

```dockerfile
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build ...
```

Docker 会在容器内编译 Linux 版本，直接部署即可。

#### 本地手动编译 Linux 版本

如果需要在 Windows 本地编译 Linux 可执行文件：

**PowerShell:**

```powershell
cd server

# 设置环境变量并编译
$env:CGO_ENABLED=0
$env:GOOS="linux"
$env:GOARCH="amd64"
go build -o server-linux -ldflags="-w -s" cmd/server/main.go

# 编译完成后恢复环境变量
Remove-Item Env:GOOS
Remove-Item Env:GOARCH
```

**CMD:**

```cmd
cd server

set CGO_ENABLED=0
set GOOS=linux
set GOARCH=amd64
go build -o server-linux -ldflags="-w -s" cmd/server/main.go

:: 编译完成后恢复
set GOOS=
set GOARCH=
```

#### 环境变量说明

| 变量 | 说明 | 可选值 |
|------|------|--------|
| `GOOS` | 目标操作系统 | `linux`, `windows`, `darwin` (macOS) |
| `GOARCH` | 目标 CPU 架构 | `amd64` (x86_64), `arm64`, `386` |
| `CGO_ENABLED` | 是否启用 CGO | `0` (禁用，推荐跨平台), `1` (启用) |

#### 常用编译目标

```powershell
# Linux 64位 (最常用的服务器)
$env:GOOS="linux"; $env:GOARCH="amd64"

# Linux ARM64 (AWS Graviton, 树莓派4等)
$env:GOOS="linux"; $env:GOARCH="arm64"

# macOS Intel
$env:GOOS="darwin"; $env:GOARCH="amd64"

# macOS Apple Silicon (M1/M2)
$env:GOOS="darwin"; $env:GOARCH="arm64"

# Windows 64位
$env:GOOS="windows"; $env:GOARCH="amd64"
```

#### 验证编译结果

```bash
# 在 Linux 服务器上检查文件类型
file server-linux
# 输出应为: server-linux: ELF 64-bit LSB executable, x86-64 ...

# 检查是否可执行
chmod +x server-linux
./server-linux --version
```

#### Windows vs Linux 主要区别

| 方面 | Windows | Linux |
|------|---------|-------|
| 可执行文件 | `server.exe` | `server` (无扩展名) |
| 路径分隔符 | `\` | `/` |
| 换行符 | `\r\n` (CRLF) | `\n` (LF) |
| 文件权限 | 无执行权限概念 | 需要 `chmod +x` |
| 配置文件路径 | `config\config.yaml` | `config/config.yaml` |

> ⚠️ **注意**: 项目代码中使用 `filepath.Join()` 处理路径，Go 会自动适配不同系统，无需手动修改代码。

#### 推荐做法

1. **开发阶段**: 在 Windows 本地直接运行 `go run` 或编译 Windows 版本测试
2. **部署阶段**: 使用 Docker 构建，自动生成 Linux 版本，避免手动处理跨平台问题
3. **CI/CD**: 在 GitHub Actions 等 CI 环境中配置多平台构建

---

## 二、Android 应用构建与发布

### 2.1 开发环境准备

#### 安装 Flutter

```bash
# Windows - 使用 Chocolatey
choco install flutter

# 或手动下载
# 1. 下载 Flutter SDK: https://flutter.dev/docs/get-started/install/windows
# 2. 解压到 C:\flutter
# 3. 添加 C:\flutter\bin 到系统 PATH

# 验证安装
flutter doctor
```

#### 安装 Android Studio

1. 下载安装 [Android Studio](https://developer.android.com/studio)
2. 安装 Flutter 和 Dart 插件
3. 配置 Android SDK (API Level 33+)
4. 创建 Android 模拟器或连接真机

### 2.2 配置生产环境

#### 修改 API 地址

编辑 `app/.env.production`:

```bash
# API 服务器地址 (使用你的实际域名)
API_BASE_URL=https://api.your-domain.com/api

# WebSocket 服务器地址
WS_BASE_URL=wss://api.your-domain.com/ws

# 环境模式
ENV_MODE=production
```

### 2.3 Android 签名配置 (重要)

#### 步骤 1: 生成签名密钥

```bash
cd app

# 生成 keystore 文件
keytool -genkey -v -keystore android/app/upload-keystore.jks -storetype JKS -keyalg RSA -keysize 2048 -validity 10000 -alias upload
```

按提示输入以下信息：
- **密钥库密码**: 设置一个强密码 (记住它!)
- **名字与姓氏**: 你的名字或公司名
- **组织单位**: 部门名称
- **组织名称**: 公司名称
- **城市**: 所在城市
- **省/市/自治区**: 所在省份
- **国家/地区代码**: CN

> ⚠️ **重要**: 妥善保管 `upload-keystore.jks` 文件和密码，丢失后无法更新应用！

#### 步骤 2: 创建签名配置文件

创建 `app/android/key.properties` 文件：

```properties
storePassword=你的密钥库密码
keyPassword=你的密钥密码
keyAlias=upload
storeFile=../app/upload-keystore.jks
```

> ⚠️ 将 `key.properties` 添加到 `.gitignore`，不要提交到代码仓库！

#### 步骤 3: 配置 Gradle 签名

编辑 `app/android/app/build.gradle`:

```gradle
// 在 android { 之前添加
def keystoreProperties = new Properties()
def keystorePropertiesFile = rootProject.file('key.properties')
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    // ... 现有配置 ...

    // 添加签名配置
    signingConfigs {
        release {
            keyAlias keystoreProperties['keyAlias']
            keyPassword keystoreProperties['keyPassword']
            storeFile keystoreProperties['storeFile'] ? file(keystoreProperties['storeFile']) : null
            storePassword keystoreProperties['storePassword']
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs.release
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
}
```

#### 步骤 4: 配置应用信息

编辑 `app/android/app/build.gradle`:

```gradle
android {
    defaultConfig {
        applicationId "com.yourcompany.fiveseconds"  // 修改为你的包名
        minSdkVersion 21
        targetSdkVersion 34
        versionCode 1        // 每次发布递增
        versionName "1.0.0"  // 版本号
    }
}
```

### 2.4 构建 Release APK

```bash
cd app

# 获取依赖
flutter pub get

# 构建 Release APK
flutter build apk --release --dart-define-from-file=.env.production

# 输出位置
# build/app/outputs/flutter-apk/app-release.apk
```

### 2.5 构建 App Bundle (Google Play 发布)

```bash
# 构建 AAB 文件
flutter build appbundle --release --dart-define-from-file=.env.production

# 输出位置
# build/app/outputs/bundle/release/app-release.aab
```

### 2.6 发布到 Google Play

#### 准备工作

1. 注册 [Google Play Console](https://play.google.com/console) 开发者账号 ($25 一次性费用)
2. 创建应用
3. 准备应用素材:
   - 应用图标 (512x512 PNG)
   - 功能图片 (1024x500)
   - 手机截图 (至少 2 张)
   - 应用描述 (简短描述 80 字符，完整描述 4000 字符)
   - 隐私政策 URL

#### 上传发布

1. 进入 Google Play Console → 你的应用
2. 选择 **发布** → **正式版**
3. 点击 **创建新版本**
4. 上传 `app-release.aab` 文件
5. 填写版本说明
6. 提交审核 (通常 1-3 天)

### 2.7 国内应用市场发布

国内市场需要 APK 文件，主要平台：

| 平台 | 开发者注册地址 |
|------|---------------|
| 华为应用市场 | https://developer.huawei.com |
| 小米应用商店 | https://dev.mi.com |
| OPPO 软件商店 | https://open.oppomobile.com |
| vivo 应用商店 | https://dev.vivo.com.cn |
| 应用宝 | https://open.tencent.com |

> 注意: 国内市场通常需要软件著作权证书和 ICP 备案

---

## 三、iOS 应用构建与发布

### 3.1 开发环境准备

> ⚠️ iOS 开发必须在 macOS 系统上进行

#### 系统要求

- macOS 12.0 (Monterey) 或更高版本
- Xcode 14.0 或更高版本
- Apple Developer 账号 ($99/年)

#### 安装开发工具

```bash
# 安装 Xcode (从 App Store)
# 或使用命令行
xcode-select --install

# 安装 Flutter
brew install flutter

# 安装 CocoaPods
sudo gem install cocoapods

# 验证环境
flutter doctor
```

### 3.2 Apple Developer 账号配置

#### 步骤 1: 注册开发者账号

1. 访问 [Apple Developer Program](https://developer.apple.com/programs/)
2. 使用 Apple ID 登录
3. 注册开发者计划 ($99/年)
4. 等待审核通过 (通常 24-48 小时)

#### 步骤 2: 创建 App ID

1. 登录 [Apple Developer Portal](https://developer.apple.com/account)
2. 进入 **Certificates, Identifiers & Profiles**
3. 选择 **Identifiers** → **+**
4. 选择 **App IDs** → **Continue**
5. 选择 **App** → **Continue**
6. 填写信息:
   - **Description**: 5SecondsGo
   - **Bundle ID**: 选择 Explicit，输入 `com.yourcompany.fiveseconds`
7. 勾选需要的 Capabilities (如 Push Notifications)
8. 点击 **Register**

#### 步骤 3: 创建证书

**开发证书 (Development)**:

1. **Certificates** → **+**
2. 选择 **Apple Development** → **Continue**
3. 创建 CSR 文件:
   ```bash
   # 在 Mac 上打开 钥匙串访问
   # 菜单: 钥匙串访问 → 证书助理 → 从证书颁发机构请求证书
   # 填写邮箱，选择"存储到磁盘"
   ```
4. 上传 CSR 文件
5. 下载证书，双击安装到钥匙串

**发布证书 (Distribution)**:

1. **Certificates** → **+**
2. 选择 **Apple Distribution** → **Continue**
3. 上传同一个 CSR 文件
4. 下载并安装证书

#### 步骤 4: 创建 Provisioning Profile

**开发 Profile**:

1. **Profiles** → **+**
2. 选择 **iOS App Development** → **Continue**
3. 选择 App ID → **Continue**
4. 选择开发证书 → **Continue**
5. 选择测试设备 → **Continue**
6. 命名为 `5SecondsGo Development`
7. 下载并双击安装

**发布 Profile (App Store)**:

1. **Profiles** → **+**
2. 选择 **App Store** → **Continue**
3. 选择 App ID → **Continue**
4. 选择发布证书 → **Continue**
5. 命名为 `5SecondsGo Distribution`
6. 下载并双击安装

### 3.3 Xcode 项目配置

#### 打开项目

```bash
cd app

# 安装依赖
flutter pub get

# 安装 iOS 依赖
cd ios
pod install
cd ..

# 打开 Xcode
open ios/Runner.xcworkspace
```

#### 配置签名

1. 在 Xcode 中选择 **Runner** 项目
2. 选择 **Runner** Target
3. 进入 **Signing & Capabilities** 标签
4. 配置:
   - **Team**: 选择你的开发者团队
   - **Bundle Identifier**: `com.yourcompany.fiveseconds`
   - **Signing Certificate**: 选择对应证书
   - 勾选 **Automatically manage signing** (推荐)

#### 配置应用信息

编辑 `app/ios/Runner/Info.plist`:

```xml
<key>CFBundleDisplayName</key>
<string>5SecondsGo</string>

<key>CFBundleName</key>
<string>5SecondsGo</string>

<key>CFBundleShortVersionString</key>
<string>1.0.0</string>

<key>CFBundleVersion</key>
<string>1</string>
```

### 3.4 构建 Release 版本

#### 命令行构建

```bash
cd app

# 构建 iOS Release
flutter build ios --release --dart-define-from-file=.env.production

# 如果遇到签名问题，使用 --no-codesign
flutter build ios --release --no-codesign --dart-define-from-file=.env.production
```

#### Xcode 归档

1. 在 Xcode 中，选择目标设备为 **Any iOS Device (arm64)**
2. 菜单: **Product** → **Archive**
3. 等待构建完成
4. 构建成功后会自动打开 **Organizer** 窗口

### 3.5 发布到 App Store

#### 步骤 1: 在 App Store Connect 创建应用

1. 登录 [App Store Connect](https://appstoreconnect.apple.com)
2. 进入 **我的 App** → **+** → **新建 App**
3. 填写信息:
   - **平台**: iOS
   - **名称**: 5SecondsGo
   - **主要语言**: 简体中文
   - **套装 ID**: 选择之前创建的 App ID
   - **SKU**: `fiveseconds001` (唯一标识)
4. 点击 **创建**

#### 步骤 2: 准备应用素材

| 素材 | 规格要求 |
|------|---------|
| 应用图标 | 1024x1024 PNG (无透明) |
| iPhone 截图 | 6.7" (1290x2796) 至少 3 张 |
| iPad 截图 | 12.9" (2048x2732) 至少 3 张 (如支持 iPad) |
| 应用预览视频 | 可选，15-30 秒 |
| 应用描述 | 最多 4000 字符 |
| 关键词 | 最多 100 字符，逗号分隔 |
| 隐私政策 URL | 必填 |
| 支持 URL | 必填 |

#### 步骤 3: 上传构建版本

**方法 1: 使用 Xcode**

1. 在 Organizer 中选择刚才的 Archive
2. 点击 **Distribute App**
3. 选择 **App Store Connect** → **Upload**
4. 按提示完成上传

**方法 2: 使用 Transporter**

1. 从 App Store 下载 [Transporter](https://apps.apple.com/app/transporter/id1450874784)
2. 导出 IPA:
   - Organizer → 选择 Archive → **Distribute App**
   - 选择 **App Store Connect** → **Export**
3. 在 Transporter 中上传 IPA 文件

#### 步骤 4: 提交审核

1. 在 App Store Connect 中选择你的应用
2. 进入 **App Store** 标签
3. 填写版本信息:
   - 新功能说明
   - 联系信息
   - 登录信息 (如需要测试账号)
4. 在 **构建版本** 中选择上传的版本
5. 点击 **提交以供审核**

#### 审核时间

- 首次提交: 通常 1-3 天
- 更新版本: 通常 24-48 小时
- 加急审核: 可申请，需说明理由

### 3.6 TestFlight 测试

在正式发布前，建议先进行 TestFlight 测试：

1. 上传构建版本后，进入 **TestFlight** 标签
2. 添加内部测试员 (最多 100 人，无需审核)
3. 添加外部测试员 (最多 10000 人，需简单审核)
4. 测试员会收到邮件邀请，通过 TestFlight App 安装测试

---

## 四、管理后台部署

### 4.1 构建 Web 版本

```bash
cd admin

# 获取依赖
flutter pub get

# 构建 Release 版本
flutter build web --release --web-renderer html

# 输出目录: build/web/
```

### 4.2 部署到服务器

```bash
# 创建部署目录
ssh user@your-server "sudo mkdir -p /var/www/fiveseconds-admin"

# 上传文件
scp -r build/web/* user@your-server:/tmp/admin-build/

# 在服务器上移动文件
ssh user@your-server "sudo mv /tmp/admin-build/* /var/www/fiveseconds-admin/"

# 设置权限
ssh user@your-server "sudo chown -R www-data:www-data /var/www/fiveseconds-admin"
```

### 4.3 Nginx 配置

管理后台的 Nginx 配置已包含在 `deploy/nginx/nginx.conf` 中，确保以下配置正确：

```nginx
server {
    listen 443 ssl http2;
    server_name admin.your-domain.com;

    # SSL 配置...

    root /var/www/fiveseconds-admin;
    index index.html;

    # Flutter Web SPA 路由
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

---

## 五、运维管理

### 5.1 常用命令

```bash
# 查看所有服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看服务日志
./scripts/deploy.sh logs server      # 后端日志
./scripts/deploy.sh logs postgres    # 数据库日志
./scripts/deploy.sh logs redis       # Redis 日志

# 健康检查
./scripts/deploy.sh health

# 重启服务
./scripts/deploy.sh restart

# 停止所有服务
./scripts/deploy.sh stop

# 备份数据库
./scripts/deploy.sh backup
```

### 5.2 数据库管理

#### 手动备份

```bash
# 备份
docker exec fiveseconds-postgres pg_dump -U fiveseconds fiveseconds | gzip > backup_$(date +%Y%m%d_%H%M%S).sql.gz

# 恢复
gunzip -c backup_20231201_120000.sql.gz | docker exec -i fiveseconds-postgres psql -U fiveseconds fiveseconds
```

#### 定时备份

```bash
# 编辑 crontab
crontab -e

# 添加每日凌晨 3 点备份
0 3 * * * cd /opt/5scondsGo && ./scripts/deploy.sh backup
```

### 5.3 监控告警

#### 访问 Grafana

- 地址: https://monitor.your-domain.com
- 默认账号: admin / (你设置的密码)

#### 预置仪表盘

- **系统概览**: CPU、内存、磁盘使用率
- **应用指标**: 请求量、响应时间、错误率
- **游戏指标**: 在线人数、房间数、下注量
- **数据库指标**: 连接数、查询性能

#### 告警配置

编辑 `deploy/alertmanager/alertmanager.yml` 配置告警通知：

```yaml
receivers:
  - name: 'email'
    email_configs:
      - to: 'admin@your-domain.com'
        from: 'alerts@your-domain.com'
        smarthost: 'smtp.example.com:587'
        auth_username: 'alerts@your-domain.com'
        auth_password: 'your-smtp-password'
```

### 5.4 日志管理

#### 查看实时日志

```bash
# 后端服务日志
docker logs -f fiveseconds-server

# 所有服务日志
docker-compose -f docker-compose.prod.yml logs -f
```

#### Loki 日志查询

在 Grafana 中使用 Explore 功能查询日志：

```logql
{container="fiveseconds-server"} |= "error"
```

### 5.5 性能优化

#### 数据库优化

```sql
-- 定期执行 VACUUM
VACUUM ANALYZE;

-- 查看慢查询
SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;
```

#### Redis 优化

```bash
# 查看内存使用
docker exec fiveseconds-redis redis-cli -a $REDIS_PASSWORD INFO memory

# 查看慢日志
docker exec fiveseconds-redis redis-cli -a $REDIS_PASSWORD SLOWLOG GET 10
```

### 5.6 安全建议

1. **定期更新**: 保持系统和 Docker 镜像更新
2. **强密码**: 所有服务使用强密码
3. **防火墙**: 只开放必要端口 (80, 443)
4. **SSL**: 强制使用 HTTPS
5. **备份**: 定期备份数据库和配置
6. **监控**: 配置告警，及时发现异常
7. **日志**: 保留足够的日志用于审计

### 5.7 故障排查

#### 服务无法启动

```bash
# 查看详细日志
docker-compose -f docker-compose.prod.yml logs server

# 检查端口占用
netstat -tlnp | grep 8080

# 检查磁盘空间
df -h
```

#### 数据库连接失败

```bash
# 检查数据库状态
docker exec fiveseconds-postgres pg_isready

# 检查连接数
docker exec fiveseconds-postgres psql -U fiveseconds -c "SELECT count(*) FROM pg_stat_activity;"
```

#### WebSocket 连接问题

1. 检查 Nginx WebSocket 配置
2. 检查防火墙是否允许 WebSocket
3. 检查 SSL 证书是否有效

---

## 附录

### A. 环境变量完整列表

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| DB_USER | 数据库用户名 | fiveseconds |
| DB_PASSWORD | 数据库密码 | your-secure-password |
| DB_NAME | 数据库名 | fiveseconds |
| REDIS_PASSWORD | Redis 密码 | your-redis-password |
| JWT_SECRET | JWT 密钥 | (openssl rand -base64 32) |
| GRAFANA_USER | Grafana 用户名 | admin |
| GRAFANA_PASSWORD | Grafana 密码 | your-grafana-password |
| API_DOMAIN | API 域名 | api.example.com |
| ADMIN_DOMAIN | 管理后台域名 | admin.example.com |
| MONITOR_DOMAIN | 监控域名 | monitor.example.com |

### B. 常见问题

**Q: Android 构建失败，提示签名错误？**

A: 检查 `key.properties` 文件路径和密码是否正确，确保 `build.gradle` 配置正确。

**Q: iOS 构建提示 Provisioning Profile 错误？**

A: 在 Xcode 中重新选择 Team，或手动下载安装最新的 Provisioning Profile。

**Q: 服务器部署后无法访问？**

A: 检查防火墙、Nginx 配置、SSL 证书，使用 `curl` 测试本地端口是否正常。

**Q: WebSocket 连接不稳定？**

A: 检查 Nginx 的 `proxy_read_timeout` 配置，建议设置为 86400s。

---

*文档版本: 1.0.0*
*最后更新: 2024年12月*
