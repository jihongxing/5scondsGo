# 5SecondsGo 技术设计文档

> 版本: V1.0
> 日期: 2025-12-07
> 状态: 待评审

---

## 1. 系统概述

### 1.1 技术栈
| 层级 | 技术选型 |
|------|----------|
| 后端 | Go 1.21+ |
| 前端(App) | Flutter 3.16+ (iOS/Android) |
| 前端(管理后台) | Flutter Web |
| 数据库 | PostgreSQL 15+ |
| 缓存/锁 | Redis 7+ |
| 实时通信 | WebSocket (gorilla/websocket) |
| 日志 | Zap + Loki |
| 监控 | Prometheus + Grafana |

### 1.2 项目结构
```
5SecondsGo/
├── server/                 # Go 后端
│   ├── cmd/
│   │   └── server/         # 主程序入口
│   ├── internal/
│   │   ├── config/         # 配置
│   │   ├── handler/        # HTTP/WS 处理器
│   │   ├── service/        # 业务逻辑
│   │   ├── repository/     # 数据访问层
│   │   ├── model/          # 数据模型
│   │   ├── game/           # 游戏引擎(状态机/随机)
│   │   └── middleware/     # 中间件
│   ├── pkg/
│   │   ├── ws/             # WebSocket 封装
│   │   ├── random/         # Commit-Reveal 随机
│   │   └── i18n/           # 多语言
│   ├── migrations/         # 数据库迁移
│   └── go.mod
├── app/                    # Flutter App
│   ├── lib/
│   │   ├── main.dart
│   │   ├── screens/        # 页面
│   │   ├── widgets/        # 组件
│   │   ├── providers/      # 状态管理
│   │   ├── services/       # API/WS服务
│   │   ├── models/         # 数据模型
│   │   └── l10n/           # 多语言
│   └── pubspec.yaml
├── admin/                  # Flutter Web 管理后台
│   └── (结构同app)
├── docs/                   # 文档
└── docker-compose.yml      # 本地开发环境
```

---

## 2. 数据库设计

### 2.1 用户表 (users)
```sql
CREATE TABLE users (
    id              BIGSERIAL PRIMARY KEY,
    username        VARCHAR(50) UNIQUE NOT NULL,
    password_hash   VARCHAR(255) NOT NULL,
    role            VARCHAR(20) NOT NULL DEFAULT 'player',  -- admin/owner/player
    invited_by      BIGINT REFERENCES users(id),            -- 邀请人(房主/admin)
    invite_code     VARCHAR(6) UNIQUE,                      -- 房主/admin的邀请码
    
    -- 玩家余额
    balance         DECIMAL(18,2) NOT NULL DEFAULT 0,
    frozen_balance  DECIMAL(18,2) NOT NULL DEFAULT 0,
    
    -- 房主专属字段
    owner_room_balance          DECIMAL(18,2) NOT NULL DEFAULT 0,
    owner_withdrawable_balance  DECIMAL(18,2) NOT NULL DEFAULT 0,
    owner_frozen_balance        DECIMAL(18,2) NOT NULL DEFAULT 0,
    owner_custody_quota         DECIMAL(18,2) NOT NULL DEFAULT 0,
    owner_margin_balance        DECIMAL(18,2) NOT NULL DEFAULT 0,
    
    status          VARCHAR(20) NOT NULL DEFAULT 'active',  -- active/disabled
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_invited_by ON users(invited_by);
CREATE INDEX idx_users_invite_code ON users(invite_code);
```

### 2.2 房间表 (rooms)
```sql
CREATE TABLE rooms (
    id                  BIGSERIAL PRIMARY KEY,
    code                VARCHAR(10) UNIQUE NOT NULL,        -- 房间码
    owner_id            BIGINT NOT NULL REFERENCES users(id),
    
    -- 房间配置
    bet_amount          DECIMAL(18,2) NOT NULL,             -- 固定下注金额: 5/10/20/50/100/200
    min_players         INT NOT NULL DEFAULT 2,             -- 最低开始人数: 2-100
    max_players         INT NOT NULL DEFAULT 10,            -- 最大人数: 2-100
    winner_count        INT NOT NULL DEFAULT 1,             -- 赢家人数: 1 ~ min_players-1
    owner_commission    DECIMAL(5,4) NOT NULL DEFAULT 0.03, -- 房主抽成: 0-0.08
    platform_commission DECIMAL(5,4) NOT NULL DEFAULT 0.02, -- 平台抽成: 固定0.02
    
    -- 状态
    status              VARCHAR(20) NOT NULL DEFAULT 'active', -- active/locked/closed
    current_round       INT NOT NULL DEFAULT 0,
    state_json          JSONB,                              -- 房间状态快照
    
    created_at          TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at          TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- 约束
    CONSTRAINT chk_bet_amount CHECK (bet_amount IN (5, 10, 20, 50, 100, 200)),
    CONSTRAINT chk_min_players CHECK (min_players >= 2 AND min_players <= 100),
    CONSTRAINT chk_max_players CHECK (max_players >= min_players AND max_players <= 100),
    CONSTRAINT chk_winner_count CHECK (winner_count >= 1 AND winner_count < min_players),
    CONSTRAINT chk_commission CHECK (owner_commission + platform_commission <= 0.10)
);

CREATE INDEX idx_rooms_owner ON rooms(owner_id);
CREATE INDEX idx_rooms_code ON rooms(code);
CREATE INDEX idx_rooms_status ON rooms(status);
```

### 2.3 游戏回合表 (game_rounds)
```sql
CREATE TABLE game_rounds (
    id              BIGSERIAL PRIMARY KEY,
    room_id         BIGINT NOT NULL REFERENCES rooms(id),
    round_number    INT NOT NULL,
    
    -- 参与信息
    participant_ids BIGINT[] NOT NULL DEFAULT '{}',
    skipped_ids     BIGINT[] NOT NULL DEFAULT '{}',         -- 余额不足跳过的玩家
    winner_ids      BIGINT[] NOT NULL DEFAULT '{}',
    
    -- 金额
    bet_amount      DECIMAL(18,2) NOT NULL,
    pool_amount     DECIMAL(18,2) NOT NULL DEFAULT 0,
    prize_per_winner DECIMAL(18,2),
    owner_earning   DECIMAL(18,2),
    platform_earning DECIMAL(18,2),
    residual_amount DECIMAL(18,2) DEFAULT 0,                -- 残差归平台
    
    -- Commit-Reveal 随机
    commit_hash     VARCHAR(64),                            -- SHA256(seed)
    reveal_seed     VARCHAR(64),                            -- 随机种子(结算后公开)
    
    -- 状态
    status          VARCHAR(20) NOT NULL DEFAULT 'betting', -- betting/playing/settled/failed
    failure_reason  VARCHAR(100),                           -- 失败原因
    
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    settled_at      TIMESTAMP,
    
    UNIQUE(room_id, round_number)
);

CREATE INDEX idx_rounds_room ON game_rounds(room_id);
CREATE INDEX idx_rounds_status ON game_rounds(status);
```

### 2.4 账本流水表 (balance_transactions)
```sql
CREATE TABLE balance_transactions (
    id              BIGSERIAL PRIMARY KEY,
    tx_type         VARCHAR(30) NOT NULL,   -- DEPOSIT/WITHDRAW/BET/WIN/LOSE/COMMISSION/PLATFORM_FEE/TRANSFER/CUSTODY_IN/CUSTODY_OUT/MARGIN_IN/MARGIN_OUT/RESIDUAL
    user_id         BIGINT NOT NULL REFERENCES users(id),
    operator_id     BIGINT REFERENCES users(id),
    room_id         BIGINT REFERENCES rooms(id),
    round_id        BIGINT REFERENCES game_rounds(id),
    
    amount          DECIMAL(18,2) NOT NULL,     -- 正=加款, 负=扣款
    balance_before  DECIMAL(18,2) NOT NULL,
    balance_after   DECIMAL(18,2) NOT NULL,
    balance_field   VARCHAR(50) NOT NULL,       -- 变动的字段名
    
    remark          VARCHAR(500),               -- 备注(替代凭证图片)
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_tx_user ON balance_transactions(user_id);
CREATE INDEX idx_tx_room ON balance_transactions(room_id);
CREATE INDEX idx_tx_round ON balance_transactions(round_id);
CREATE INDEX idx_tx_type ON balance_transactions(tx_type);
CREATE INDEX idx_tx_created ON balance_transactions(created_at);
```

### 2.5 资金申请表 (fund_requests)
```sql
CREATE TABLE fund_requests (
    id              BIGSERIAL PRIMARY KEY,
    request_type    VARCHAR(30) NOT NULL,   -- PLAYER_DEPOSIT/PLAYER_WITHDRAW/OWNER_CUSTODY/OWNER_MARGIN_IN/OWNER_MARGIN_OUT/OWNER_WITHDRAW
    user_id         BIGINT NOT NULL REFERENCES users(id),
    owner_id        BIGINT REFERENCES users(id),        -- 关联房主(玩家请求时)
    
    amount          DECIMAL(18,2) NOT NULL,
    status          VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending/approved/rejected/completed
    
    payment_account VARCHAR(200),           -- 收款账户(提现用)
    remark          VARCHAR(500),           -- 备注
    
    operator_id     BIGINT REFERENCES users(id),
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_fund_user ON fund_requests(user_id);
CREATE INDEX idx_fund_owner ON fund_requests(owner_id);
CREATE INDEX idx_fund_status ON fund_requests(status);
```

### 2.6 平台账户表 (platform_account)
```sql
CREATE TABLE platform_account (
    id              BIGSERIAL PRIMARY KEY,
    balance         DECIMAL(18,2) NOT NULL DEFAULT 0,   -- 平台总收入(抽成+残差)
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 初始化一条记录
INSERT INTO platform_account (id, balance) VALUES (1, 0);
```

### 2.7 房间玩家关联表 (room_players)
```sql
CREATE TABLE room_players (
    id              BIGSERIAL PRIMARY KEY,
    room_id         BIGINT NOT NULL REFERENCES rooms(id),
    user_id         BIGINT NOT NULL REFERENCES users(id),
    
    auto_ready      BOOLEAN NOT NULL DEFAULT FALSE,
    is_online       BOOLEAN NOT NULL DEFAULT FALSE,
    joined_at       TIMESTAMP NOT NULL DEFAULT NOW(),
    
    UNIQUE(room_id, user_id)
);

CREATE INDEX idx_rp_room ON room_players(room_id);
CREATE INDEX idx_rp_user ON room_players(user_id);
```

---

## 3. 核心业务逻辑

### 3.1 游戏状态机

```
┌─────────┐
│ WAITING │◄──────────────────────────────────┐
└────┬────┘                                   │
     │ 准备人数达标                            │
     ▼                                        │
┌───────────┐                                 │
│ COUNTDOWN │ 5秒                             │
└─────┬─────┘                                 │
      │ 准备人数不达标 ──────────────────────────┘
      │ 倒计时结束
      ▼
┌─────────┐
│ BETTING │ 5秒 (进入时立即自动扣款)
└────┬────┘
     │ 参与人数<赢家数 → FAILED → 退款 → WAITING
     │ 正常
     ▼
┌─────────┐
│ IN_GAME │ 5秒 (动画展示, Commit阶段)
└────┬────┘
     │
     ▼
┌────────────┐
│ SETTLEMENT │ 5秒 (Reveal+结算+展示结果)
└─────┬──────┘
      │
      ▼
┌───────┐
│ RESET │ 瞬时 → 检查准备人数 → COUNTDOWN 或 WAITING
└───────┘
```

### 3.2 Commit-Reveal 可验证随机

**Commit 阶段 (进入 IN_GAME 时)**:
```go
seed := generateSecureRandom(32)           // 32字节随机种子
commitHash := sha256(seed)                  // 计算哈希
// 存储 seed 到内存, commitHash 写入数据库
// 广播 commitHash 给全房间
```

**Reveal 阶段 (进入 SETTLEMENT 时)**:
```go
// 从内存取出 seed
// 验证 sha256(seed) == commitHash
winners := selectWinners(participantIds, winnerCount, seed)
// 将 seed 写入数据库, 广播给全房间
```

**选择赢家算法**:
```go
func selectWinners(participants []int64, count int, seed []byte) []int64 {
    // Fisher-Yates shuffle with deterministic seed
    rng := rand.New(rand.NewSource(bytesToInt64(seed)))
    shuffled := make([]int64, len(participants))
    copy(shuffled, participants)
    for i := len(shuffled) - 1; i > 0; i-- {
        j := rng.Intn(i + 1)
        shuffled[i], shuffled[j] = shuffled[j], shuffled[i]
    }
    return shuffled[:count]
}
```

### 3.3 结算公式

```
设:
  N = 参与人数
  B = 固定下注金额
  W = 赢家人数
  R_owner = 房主抽成比例 (默认0.03)
  R_platform = 平台抽成比例 (固定0.02)

奖池总额:
  Pool = N × B

抽成:
  OwnerFee = Pool × R_owner
  PlatformFee = Pool × R_platform
  TotalFee = OwnerFee + PlatformFee

可分配奖金:
  Distributable = Pool - TotalFee

每个赢家奖金(向下取整到分):
  PrizePerWinner = floor(Distributable / W × 100) / 100

残差归平台:
  Residual = Distributable - (PrizePerWinner × W)

最终平台收入:
  PlatformTotal = PlatformFee + Residual
```

### 3.4 风控校验

**玩家充值前校验**:
```go
func canDeposit(owner *User, amount decimal.Decimal) error {
    // 1. 房主托管额度是否充足
    if owner.OwnerCustodyQuota.LessThan(amount) {
        return ErrInsufficientCustodyQuota
    }
    // 2. 托管额度不能为负
    if owner.OwnerCustodyQuota.Sub(amount).LessThan(decimal.Zero) {
        return ErrCustodyQuotaWouldBeNegative
    }
    return nil
}
```

**每次资金变动后校验**:
```go
func validateOwnerRisk(owner *User, playersTotalBalance decimal.Decimal) error {
    // 玩家总余额 <= 托管额度 + 保证金
    maxAllowed := owner.OwnerCustodyQuota.Add(owner.OwnerMarginBalance)
    if playersTotalBalance.GreaterThan(maxAllowed) {
        // 锁定房主名下所有房间
        lockOwnerRooms(owner.ID)
        return ErrRiskLimitExceeded
    }
    return nil
}
```

**保证金/托管额度阈值**:
```go
const (
    MinMarginBalance  = 2000.00  // 最低保证金
    MinCustodyQuota   = 2000.00  // 最低托管额度
)
```

---

## 4. API 设计

### 4.1 REST API

#### 认证
| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/auth/register | 注册(需邀请码) |
| POST | /api/auth/login | 登录 |
| POST | /api/auth/logout | 登出 |
| GET  | /api/auth/me | 获取当前用户信息 |

#### 房间
| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/rooms | 创建房间(房主) |
| GET  | /api/rooms | 获取房间列表 |
| GET  | /api/rooms/:code | 获取房间详情 |
| PUT  | /api/rooms/:code | 修改房间配置(房主) |
| POST | /api/rooms/:code/join | 加入房间 |
| POST | /api/rooms/:code/leave | 离开房间 |

#### 资金(玩家)
| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/fund/withdraw-request | 发起提现申请 |
| GET  | /api/fund/my-requests | 我的申请记录 |
| GET  | /api/fund/my-transactions | 我的流水记录 |

#### 资金(房主)
| 方法 | 路径 | 描述 |
|------|------|------|
| GET  | /api/owner/players | 名下玩家列表 |
| POST | /api/owner/deposit | 为玩家充值 |
| GET  | /api/owner/withdraw-requests | 玩家提现申请列表 |
| POST | /api/owner/approve-withdraw/:id | 审批玩家提现 |
| POST | /api/owner/transfer | 收益结转 |
| POST | /api/owner/withdraw-request | 房主提现申请 |
| GET  | /api/owner/transactions | 房主流水 |

#### 管理后台(Admin)
| 方法 | 路径 | 描述 |
|------|------|------|
| GET  | /api/admin/owners | 房主列表 |
| POST | /api/admin/owners/:id/custody | 调整房主托管额度 |
| POST | /api/admin/owners/:id/margin | 调整房主保证金 |
| GET  | /api/admin/fund-requests | 待审核申请列表 |
| POST | /api/admin/fund-requests/:id/approve | 审批通过 |
| POST | /api/admin/fund-requests/:id/reject | 审批拒绝 |
| GET  | /api/admin/rooms | 所有房间 |
| POST | /api/admin/rooms/:id/lock | 锁定房间 |
| GET  | /api/admin/transactions | 全平台流水 |
| GET  | /api/admin/reports/balance-check | 资金守恒检查报告 |
| GET  | /api/admin/platform-account | 平台账户信息 |

### 4.2 WebSocket 事件

#### 客户端 → 服务端
| 事件 | 描述 | 载荷 |
|------|------|------|
| `join_room` | 加入房间 | `{room_code}` |
| `leave_room` | 离开房间 | `{}` |
| `toggle_ready` | 切换准备状态 | `{auto_ready: bool}` |
| `ping` | 心跳 | `{}` |

#### 服务端 → 客户端
| 事件 | 描述 | 载荷 |
|------|------|------|
| `room_snapshot` | 房间完整状态(加入/重连) | `{room, players, phase, ...}` |
| `player_joined` | 玩家加入 | `{player}` |
| `player_left` | 玩家离开 | `{user_id}` |
| `ready_changed` | 准备状态变化 | `{user_id, auto_ready}` |
| `phase_changed` | 阶段切换 | `{phase, time_left, round}` |
| `phase_tick` | 阶段计时 | `{phase, time_left, pool_amount}` |
| `betting_completed` | 下注完成 | `{pool_amount, participants, skipped}` |
| `commit_hash` | 随机承诺 | `{commit_hash}` |
| `round_result` | 回合结果 | `{winners, prize, reveal_seed}` |
| `round_failed` | 回合失败 | `{reason, refunded}` |
| `balance_updated` | 余额更新 | `{balance, frozen_balance}` |
| `system_alert` | 系统提示 | `{level, message}` |
| `pong` | 心跳响应 | `{server_time}` |
| `error` | 错误 | `{code, message}` |

---

## 5. 错误码定义

| 错误码 | 中文 | English |
|--------|------|---------|
| 1001 | 用户名已存在 | Username already exists |
| 1002 | 邀请码无效 | Invalid invite code |
| 1003 | 用户名或密码错误 | Invalid username or password |
| 1004 | 账户已被禁用 | Account disabled |
| 2001 | 房间不存在 | Room not found |
| 2002 | 房间已满 | Room is full |
| 2003 | 房间已锁定 | Room is locked |
| 2004 | 无权操作此房间 | No permission for this room |
| 2005 | 赢家数量必须小于最低人数 | Winner count must be less than min players |
| 3001 | 余额不足 | Insufficient balance |
| 3002 | 托管额度不足 | Insufficient custody quota |
| 3003 | 保证金不足 | Insufficient margin balance |
| 3004 | 风险超限,房间已锁定 | Risk limit exceeded, room locked |
| 3005 | 金额必须大于0 | Amount must be greater than 0 |
| 4001 | 游戏进行中,无法操作 | Game in progress |
| 4002 | 参与人数不足 | Not enough participants |
| 4003 | 本轮已失败 | Round failed |

---

## 6. 多语言词条表

### 6.1 通用
| Key | 中文 | English |
|-----|------|---------|
| app_name | 5秒押注 | 5SecondsGo |
| loading | 加载中... | Loading... |
| confirm | 确认 | Confirm |
| cancel | 取消 | Cancel |
| save | 保存 | Save |
| submit | 提交 | Submit |
| success | 成功 | Success |
| failed | 失败 | Failed |
| error | 错误 | Error |
| warning | 警告 | Warning |
| retry | 重试 | Retry |

### 6.2 认证
| Key | 中文 | English |
|-----|------|---------|
| login | 登录 | Login |
| register | 注册 | Register |
| logout | 登出 | Logout |
| username | 用户名 | Username |
| password | 密码 | Password |
| invite_code | 邀请码 | Invite Code |
| login_success | 登录成功 | Login successful |
| register_success | 注册成功 | Registration successful |

### 6.3 游戏阶段
| Key | 中文 | English |
|-----|------|---------|
| phase_waiting | 等待中 | Waiting |
| phase_countdown | 倒计时 | Countdown |
| phase_betting | 下注中 | Betting |
| phase_playing | 游戏中 | Playing |
| phase_settlement | 结算中 | Settlement |
| phase_reset | 重置中 | Resetting |

### 6.4 房间
| Key | 中文 | English |
|-----|------|---------|
| room_code | 房间码 | Room Code |
| create_room | 创建房间 | Create Room |
| join_room | 加入房间 | Join Room |
| leave_room | 离开房间 | Leave Room |
| bet_amount | 下注金额 | Bet Amount |
| min_players | 最低人数 | Min Players |
| max_players | 最大人数 | Max Players |
| winner_count | 赢家人数 | Winner Count |
| commission | 抽成比例 | Commission |
| prize_pool | 奖池 | Prize Pool |
| round | 第{n}轮 | Round {n} |
| players_count | {n}/{m}人 | {n}/{m} Players |

### 6.5 准备状态
| Key | 中文 | English |
|-----|------|---------|
| auto_ready | 自动准备 | Auto Ready |
| auto_ready_on | 自动准备 - 开 | Auto Ready - ON |
| auto_ready_off | 自动准备 - 关 | Auto Ready - OFF |
| ready | 已准备 | Ready |
| not_ready | 未准备 | Not Ready |

### 6.6 结算
| Key | 中文 | English |
|-----|------|---------|
| you_win | 恭喜获胜! | You Win! |
| you_lose | 很遗憾 | You Lose |
| winners | 赢家 | Winners |
| prize | 奖金 | Prize |
| skipped | 余额不足已跳过 | Skipped (insufficient balance) |

### 6.7 资金
| Key | 中文 | English |
|-----|------|---------|
| balance | 余额 | Balance |
| frozen | 冻结中 | Frozen |
| deposit | 充值 | Deposit |
| withdraw | 提现 | Withdraw |
| amount | 金额 | Amount |
| remark | 备注 | Remark |
| pending | 待处理 | Pending |
| approved | 已通过 | Approved |
| rejected | 已拒绝 | Rejected |
| completed | 已完成 | Completed |

### 6.8 管理后台
| Key | 中文 | English |
|-----|------|---------|
| dashboard | 控制台 | Dashboard |
| owner_management | 房主管理 | Owner Management |
| room_management | 房间管理 | Room Management |
| fund_audit | 资金审核 | Fund Audit |
| reports | 报表 | Reports |
| custody_quota | 托管额度 | Custody Quota |
| margin_balance | 保证金 | Margin Balance |
| platform_income | 平台收入 | Platform Income |

---

## 7. 初始化数据

### 7.1 Admin 账号
```sql
INSERT INTO users (username, password_hash, role, invite_code)
VALUES ('admin', '$2a$10$...', 'admin', 'ADMIN1');
```
- 用户名: `admin`
- 密码: `admin123` (首次登录强制修改)
- 邀请码: `ADMIN1` (用于邀请房主注册)

### 7.2 平台账户
```sql
INSERT INTO platform_account (id, balance) VALUES (1, 0);
```

---

## 8. 部署配置

### 8.1 配置文件 (config.yaml)
```yaml
server:
  host: 0.0.0.0
  port: 8080
  ws_path: /ws

database:
  host: localhost
  port: 5432
  user: fiveseconds
  password: ${DB_PASSWORD}
  dbname: fiveseconds
  sslmode: disable

redis:
  host: localhost
  port: 6379
  password: ${REDIS_PASSWORD}
  db: 0

game:
  phase_duration: 5           # 每阶段时长(秒)
  tick_interval: 1            # tick间隔(秒)
  bet_amounts: [5, 10, 20, 50, 100, 200]
  max_room_players: 100
  min_room_players: 2
  default_owner_commission: 0.03
  platform_commission: 0.02
  max_total_commission: 0.10
  min_margin_balance: 2000
  min_custody_quota: 2000

logging:
  level: info
  format: json

monitoring:
  prometheus_port: 9090
```

### 8.2 Docker Compose
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: fiveseconds
      POSTGRES_PASSWORD: fiveseconds
      POSTGRES_DB: fiveseconds
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  loki:
    image: grafana/loki:2.9.0
    ports:
      - "3100:3100"

  prometheus:
    image: prom/prometheus:v2.47.0
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana:10.2.0
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin

volumes:
  postgres_data:
```

---

## 9. 开发里程碑

### Phase 1: 基础框架 (Week 1)
- [ ] 项目初始化 (Go mod, Flutter)
- [ ] 数据库迁移脚本
- [ ] 用户认证 (注册/登录/邀请码)
- [ ] 基础 REST API 框架
- [ ] WebSocket 连接管理

### Phase 2: 游戏核心 (Week 2)
- [ ] 房间 CRUD
- [ ] RoomProcessor 状态机
- [ ] 自动下注与扣款
- [ ] Commit-Reveal 随机
- [ ] 结算与分配

### Phase 3: 资金系统 (Week 3)
- [ ] 玩家充值/提现流程
- [ ] 房主托管额度
- [ ] 房主保证金
- [ ] 风控校验
- [ ] 账本流水

### Phase 4: 前端 App (Week 4)
- [ ] Flutter 项目初始化
- [ ] 登录/注册页
- [ ] 房间列表/详情页
- [ ] 游戏主界面
- [ ] 多语言支持

### Phase 5: 管理后台 (Week 5)
- [ ] Flutter Web 管理后台
- [ ] 房主管理
- [ ] 资金审核
- [ ] 报表与审计

### Phase 6: 测试与上线 (Week 6)
- [ ] 单元测试
- [ ] E2E 测试
- [ ] 压力测试
- [ ] 日志/监控接入
- [ ] 部署文档

---

**文档完成，待评审后开始实施。**


---

## 10. P1/P2 功能扩展设计

> 版本: V2.0
> 更新日期: 2025-12-09

### 10.1 观战模式

#### 架构设计
```go
// SpectatorManager 观战者管理
type SpectatorManager struct {
    spectators    map[int64]*SpectatorState  // userID -> state
    maxSpectators int                         // 最大观战人数 (50)
}

type SpectatorState struct {
    UserID    int64
    Username  string
    JoinedAt  time.Time
}
```

#### 核心逻辑
- 观战者与参与者分离管理
- 观战者接收所有游戏状态更新，但不参与下注
- 支持观战者切换为参与者（房间未满时）
- 最大观战人数限制：50人

### 10.2 聊天与表情系统

#### 聊天服务
```go
type ChatService struct {
    repo            *repository.ChatRepo
    filter          *ContentFilter      // 敏感词过滤
    chatRateLimiter *RateLimiter        // 1条/秒
    emojiRateLimiter *RateLimiter       // 3次/秒
}
```

#### 限流策略
- 聊天消息：每用户每秒1条
- 表情反应：每用户每秒3次
- 使用滑动窗口算法实现

#### 内容过滤
- 敏感词替换为星号
- 消息长度限制：200字符
- 历史消息保留：100条

### 10.3 好友与邀请系统

#### 数据模型
```sql
-- 好友关系表（双向）
CREATE TABLE friends (
    user_id   BIGINT NOT NULL,
    friend_id BIGINT NOT NULL,
    UNIQUE(user_id, friend_id)
);

-- 邀请链接表
CREATE TABLE invite_links (
    code       VARCHAR(32) UNIQUE,
    room_id    BIGINT NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    use_count  INT DEFAULT 0
);
```

#### 在线状态追踪
- 使用 Redis 存储在线状态
- 好友上下线实时通知
- 显示好友当前所在房间

### 10.4 余额缓存机制

#### 缓存架构
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Client    │────▶│ BalanceCache│────▶│  PostgreSQL │
└─────────────┘     └─────────────┘     └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │    Redis    │
                    └─────────────┘
```

#### 乐观锁机制
```go
func (c *BalanceCache) UpdateWithVersion(
    ctx context.Context, 
    userID int64, 
    delta decimal.Decimal, 
    expectedVersion int64,
) (*CachedBalance, error) {
    // 使用 balance_version 字段防止并发冲突
    newBalance, newVersion, err := c.userRepo.UpdateBalanceWithVersion(
        ctx, userID, delta, expectedVersion,
    )
    if err != nil {
        if errors.Is(err, repository.ErrVersionConflict) {
            return nil, ErrVersionConflict
        }
        return nil, err
    }
    // 更新缓存
    return c.LoadFromDB(ctx, userID)
}
```

#### 降级策略
- Redis 不可用时自动降级到数据库直读
- 缓存过期时间：30分钟
- 写操作同时更新数据库和缓存

### 10.5 Phase Tick 优化

#### 增量状态广播
```go
type WSPhaseTick struct {
    ServerTime     int64   `json:"server_time"`
    PhaseEndTime   int64   `json:"phase_end_time,omitempty"`
    TimeRemaining  int64   `json:"time_remaining,omitempty"`
    Phase          *string `json:"phase,omitempty"`          // 仅变化时发送
    PoolAmount     *string `json:"pool_amount,omitempty"`    // 仅变化时发送
    PlayerCount    *int    `json:"player_count,omitempty"`   // 仅变化时发送
}
```

#### 优化策略
- 只发送变化的字段
- 无状态变化时跳过广播
- 活跃阶段 tick 间隔：1秒
- 等待阶段 tick 间隔：3秒

### 10.6 风控与告警系统

#### 风控检测规则
| 规则 | 阈值 | 动作 |
|------|------|------|
| 连续获胜 | >10轮 | 标记审核 |
| 高胜率 | >80% (50轮) | 标记审核 |
| 多账户 | 相同设备指纹 | 标记审核 |

#### 告警触发条件
| 告警类型 | 条件 | 严重程度 |
|----------|------|----------|
| 负余额 | 玩家余额 < 0 | Critical |
| 大额交易 | 单笔 > 10000 | Warning |
| 结算失败 | 连续3次失败 | Critical |
| 资金不守恒 | 校验失败 | Critical |

### 10.7 监控仪表盘

#### 实时指标
```go
type RealtimeMetrics struct {
    OnlinePlayers    int             // 在线玩家数
    ActiveRooms      int             // 活跃房间数
    GamesPerMinute   float64         // 每分钟游戏数
    APILatencyP95    float64         // API延迟P95
    WSLatencyP95     float64         // WebSocket延迟P95
    DBLatencyP95     float64         // 数据库延迟P95
    DailyActiveUsers int             // 日活用户
    DailyVolume      decimal.Decimal // 日交易量
    PlatformRevenue  decimal.Decimal // 平台收入
}
```

#### 指标采集
- 实时指标：Redis 存储，10秒更新
- 历史指标：每分钟快照存入数据库
- 支持时间范围查询：1小时/24小时/7天/30天

### 10.8 房间主题

#### 内置主题
| 主题名 | 主色调 | 背景色 |
|--------|--------|--------|
| Classic | #1976D2 | #FFFFFF |
| Neon | #FF00FF | #000000 |
| Ocean | #00BCD4 | #E0F7FA |
| Forest | #4CAF50 | #E8F5E9 |
| Luxury | #FFD700 | #1A1A1A |

#### 主题切换
- 房主可随时切换主题
- 主题变更实时广播给所有房间成员
- 新加入玩家自动加载房间主题

### 10.9 多语言支持

#### 支持语言
- 简体中文 (zh)
- 繁体中文 (zh_TW)
- 英语 (en)
- 日语 (ja)
- 韩语 (ko)

#### 语言回退
```
用户偏好语言 → 设备系统语言 → 英语 (默认)
```

---

## 11. 新增数据库表

### 11.1 P1/P2 迁移脚本

```sql
-- 聊天消息表
CREATE TABLE chat_messages (
    id          BIGSERIAL PRIMARY KEY,
    room_id     BIGINT NOT NULL REFERENCES rooms(id),
    user_id     BIGINT NOT NULL REFERENCES users(id),
    content     VARCHAR(200) NOT NULL,
    created_at  TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX idx_chat_room_time ON chat_messages(room_id, created_at DESC);

-- 好友关系表
CREATE TABLE friends (
    id          BIGSERIAL PRIMARY KEY,
    user_id     BIGINT NOT NULL REFERENCES users(id),
    friend_id   BIGINT NOT NULL REFERENCES users(id),
    created_at  TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE(user_id, friend_id)
);

-- 好友请求表
CREATE TABLE friend_requests (
    id           BIGSERIAL PRIMARY KEY,
    from_user_id BIGINT NOT NULL REFERENCES users(id),
    to_user_id   BIGINT NOT NULL REFERENCES users(id),
    status       VARCHAR(20) NOT NULL DEFAULT 'pending',
    created_at   TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 房间邀请表
CREATE TABLE room_invitations (
    id           BIGSERIAL PRIMARY KEY,
    room_id      BIGINT NOT NULL REFERENCES rooms(id),
    from_user_id BIGINT NOT NULL REFERENCES users(id),
    to_user_id   BIGINT NOT NULL REFERENCES users(id),
    status       VARCHAR(20) NOT NULL DEFAULT 'pending',
    expires_at   TIMESTAMP NOT NULL
);

-- 邀请链接表
CREATE TABLE invite_links (
    id          BIGSERIAL PRIMARY KEY,
    room_id     BIGINT NOT NULL REFERENCES rooms(id),
    code        VARCHAR(32) UNIQUE NOT NULL,
    created_by  BIGINT NOT NULL REFERENCES users(id),
    expires_at  TIMESTAMP NOT NULL,
    use_count   INT NOT NULL DEFAULT 0
);

-- 房间主题表
CREATE TABLE room_themes (
    id          BIGSERIAL PRIMARY KEY,
    room_id     BIGINT UNIQUE NOT NULL REFERENCES rooms(id),
    theme_name  VARCHAR(50) NOT NULL DEFAULT 'classic'
);

-- 风控标记表
CREATE TABLE risk_flags (
    id          BIGSERIAL PRIMARY KEY,
    user_id     BIGINT NOT NULL REFERENCES users(id),
    flag_type   VARCHAR(50) NOT NULL,
    details     JSONB,
    status      VARCHAR(20) NOT NULL DEFAULT 'pending',
    created_at  TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 告警记录表
CREATE TABLE alerts (
    id          BIGSERIAL PRIMARY KEY,
    alert_type  VARCHAR(50) NOT NULL,
    severity    VARCHAR(20) NOT NULL,
    title       VARCHAR(200) NOT NULL,
    details     JSONB,
    status      VARCHAR(20) NOT NULL DEFAULT 'active',
    created_at  TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 指标快照表
CREATE TABLE metrics_snapshots (
    id                  BIGSERIAL PRIMARY KEY,
    online_players      INT NOT NULL,
    active_rooms        INT NOT NULL,
    games_per_minute    DECIMAL(10,2) NOT NULL,
    api_latency_p95     DECIMAL(10,2) NOT NULL,
    ws_latency_p95      DECIMAL(10,2) NOT NULL,
    db_latency_p95      DECIMAL(10,2) NOT NULL,
    daily_active_users  INT NOT NULL,
    daily_volume        DECIMAL(18,2) NOT NULL,
    platform_revenue    DECIMAL(18,2) NOT NULL,
    created_at          TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 用户表扩展
ALTER TABLE users ADD COLUMN IF NOT EXISTS device_fingerprint VARCHAR(64);
ALTER TABLE users ADD COLUMN IF NOT EXISTS balance_version BIGINT NOT NULL DEFAULT 0;
ALTER TABLE users ADD COLUMN IF NOT EXISTS language VARCHAR(10) NOT NULL DEFAULT 'zh';
ALTER TABLE users ADD COLUMN IF NOT EXISTS consecutive_wins INT NOT NULL DEFAULT 0;
```

---

## 12. 测试策略

### 12.1 单元测试
- 聊天消息截断逻辑
- 限流器行为
- 好友关系双向性
- 余额缓存一致性
- 风控检测算法

### 12.2 集成测试
- WebSocket 消息广播
- 多用户并发操作
- 缓存失效降级

### 12.3 属性测试
使用 `github.com/leanovate/gopter`:
- 观战者隔离测试
- 聊天截断测试
- 限流测试
- 好友双向性测试
- 缓存一致性测试

---

**P1/P2 功能设计完成，已集成到主系统。**
