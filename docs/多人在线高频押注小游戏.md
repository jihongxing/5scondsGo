# Agent A - 最终整合文档

> 时间: 06:39:45
> Tokens: 14707

---

# **多人在线高频押注小游戏 - 产品需求文档 (PRD) 最终整合版**

## **文档状态**
- **版本**：V1.4 (发布版)
- **状态**：已批准，基线化
- **目标**：指导详细技术设计与开发

---

## **1. 项目概述**

### **1.1 产品愿景**
打造一款轻量级、高实时性、社交属性强的多人即时押注小游戏，通过高频次、低门槛的游戏循环，提升用户粘性与平台活跃度。

### **1.2 核心玩法**
1. **房间制**：玩家创建或加入房间（2-100人）。
2. **游戏循环**：每轮游戏包含“准备→倒计时→下注→游戏进行→结算”5个阶段，循环进行。
3. **自动下注与收益**：进入下注阶段时，系统自动按房间设定的固定金额扣除所有参与玩家的余额，赢家按比例瓜分奖池。
4. **资金闭环**：平台内虚拟币充值、消耗、提现（房主收益）形成完整经济循环。

### **1.3 核心价值**
- **用户价值**：简单刺激的即时反馈、社交互动、小额竞技乐趣，无需手动下注。
- **商业价值**：提升用户时长与留存，通过虚拟币消耗与房主抽成创造营收点。

---

## **2. 核心功能需求**

### **2.1 功能优先级**

#### **P0 (核心MVP - 必须上线)**
1. **房间管理**：创建/加入/离开房间，房间状态展示。
2. **游戏流程引擎**：完整的5阶段状态机循环。
3. **自动下注与结算**：进入下注阶段自动扣款、自动计算分配、实时结果显示。
4. **资金安全流转**（纯线下模式，房主托管）：
   - **平台不对接玩家**：玩家充值/提现完全由房主线下处理，平台仅记录凭证
   - **平台仅对接房主**：房主充值托管额度、房主保证金、房主提现
   - **房主托管额度**：玩家充值消耗额度，玩家提现回补额度，保证资金守恒
   - **原子化结算**：数据库事务+固定锁顺序（按user_id升序）
   - **账本记录**：所有资金变动全部记录，支持审计追溯与资金守恒校验
5. **实时通信**：基于WebSocket的事件驱动状态同步。
6. **断线重连恢复**：玩家重连后恢复游戏状态。

#### **P1 (体验增强)**
1. **观战模式**：允许用户进入房间观战。
2. **聊天与表情**：房间内文字与表情互动。
3. **游戏记录与回放**：查看历史对局详情。
4. **基础社交**：好友关系、邀请功能。
5. **多语言支持**：UI支持中文/英文切换。

#### **P2 (扩展/优化)**
1. **平台管理端**：全局监控、财务审核、性能监控仪表盘。
2. **性能优化**：余额缓存机制、`phase_tick`频率优化、状态机演进。
3. **游戏变体**：不同押注模式、主题皮肤。
4. **反作弊与风控**：基础行为模式检测。

### **2.2 详细用户故事与验收标准**

#### **US-01 玩家加入与准备**
- **作为** 玩家
- **我希望** 能够快速加入房间并准备游戏
- **以便** 开始游戏循环
- **验收标准**：
  1. 玩家可通过房间号或随机匹配加入房间。
  2. 加入后实时看到房间内其他玩家及状态。
  3. 玩家可点击“准备”按钮，状态实时同步给全房间。
  4. 当准备人数达到房主设定下限时，游戏自动进入倒计时阶段。

#### **US-02 自动下注**
- **作为** 系统
- **我希望** 在进入下注阶段时自动扣除所有参与玩家的固定金额
- **以便** 简化操作，加快游戏节奏
- **验收标准**：
  1. 进入下注阶段时，系统自动按房间设定的**固定下注金额**扣除所有“自动准备”状态玩家的余额。
  2. 余额不足的玩家自动跳过本轮（不扣款、不参与），并收到系统提示。
  3. 扣款成功的玩家自动加入本轮奖池，无需手动操作。
  4. 奖池金额 = 参与人数 × 固定下注金额，实时广播给全房间。

#### **US-03 系统资金结算**
- **作为** 系统
- **我希望** 在每轮游戏结束后安全、准确地结算资金
- **以便** 维护游戏经济系统的公平与稳定
- **验收标准**：
  1. 游戏结果显示后，系统自动计算赢家并分配奖池。
  2. 输家余额被扣减，赢家获得对应收益（扣除房主抽成）。
  3. 房主抽成（如5%）计入房主的房间收益账户。
  4. 所有资金变动记录在`balance_transaction`表中，包含`round_id`。
  5. 结算过程必须在一个数据库事务中完成，保证原子性。
  6. **并发控制**：扣减玩家余额时，必须按照`user_id`升序排列的顺序依次加锁，避免死锁。
  7. **性能监控**：事务执行时间应被监控，若平均耗时超过阈值（如50ms），需触发告警。
  8. **事务超时与降级**：结算事务必须在设定超时时间（如1秒）内完成。若超时：
     - 回滚数据库事务
     - 将房间状态置为`ERROR_RECOVERING`
     - 向全房间广播`system_alert`事件，提示“结算处理中，请耐心等待”
     - 触发后台告警，并尝试在延迟后自动重试（最多3次）

#### **US-04 房主收益管理**
- **作为** 房主
- **我希望** 能够查看和管理我的游戏收益
- **以便** 提取我的劳动所得
- **验收标准**：
  1. 房主在房间内实时看到累计收益（`owner_room_balance`）。
  2. 房主可将收益结转至可提现账户（`owner_withdrawable_balance`）。
  3. 房主可发起提现申请，进入平台审核流程。
  4. 平台审核通过后，**线下打款**给房主，房主或平台上传打款凭证确认完成。

#### **US-05 房主收益结转（强化版）**
- **作为** 房主
- **我希望** 安全地将房间收益转为可提现金额
- **以便** 避免游戏结算期间的冲突
- **验收标准**：
  1. 房主可发起“收益结转”，将`owner_room_balance`转入`owner_withdrawable_balance`。
  2. **并发控制**：结转操作与游戏结算互斥。**后端必须校验**：只有当房间的当前阶段为`WAITING`或`RESET`时，才允许执行结转操作。前端按钮状态应与此规则同步。
  3. 提现申请提交后，金额从`owner_withdrawable_balance`中冻结，状态为“平台审核中”。
  4. 平台审核打款后，扣减冻结金额。

#### **US-06 玩家断线重连**
- **作为** 玩家
- **我希望** 网络异常恢复后能重新加入游戏并看到最新状态
- **以便** 继续参与游戏
- **验收标准**：
  1. 玩家断线后，其游戏内角色（准备状态、是否参与本轮）由断线瞬间的服务端状态决定。
  2. 玩家重连时，服务端向该玩家单播完整的`server_room_snapshot`事件。
  3. 前端用快照数据完全覆盖本地状态，无状态猜测或恢复。
  4. 玩家重连时，剩余时间正确显示。

#### **US-07 玩家充值流程（房主托管模式）**
- **作为** 玩家
- **我希望** 通过线下转账给房主来充值游戏余额
- **以便** 参与游戏
- **验收标准**：
  1. 玩家线下转账给房主（微信/支付宝/银行转账等），平台不参与代收。
  2. 房主在后台为玩家发起“充值操作”，输入金额并上传转账凭证截图。
  3. 系统校验房主 `owner_custody_quota` 是否充足，不足则拒绝操作。
  4. 房主确认后，账务处理：`owner_custody_quota` 减少，同额增加玩家 `balance`，记录到`balance_transaction`表。
  5. 所有充值记录包含：操作人（房主）、目标用户、金额、凭证图片URL、时间戳。

#### **US-08 玩家提现流程（线下模式）**
- **作为** 玩家
- **我希望** 将游戏余额提现为现金
- **以便** 取出我的赢利
- **验收标准**：
  1. 玩家在APP内发起提现申请，输入金额和收款账户信息。
  2. 系统校验余额充足后，冻结该金额，状态为“待房主打款”。
  3. 房主收到提现请求后，**线下打款**给玩家（平台不参与代付）。
  4. 房主在后台上传打款凭证，确认完成。
  5. 系统扣减玩家冻结余额，并同额增加 `owner_custody_quota`，记录到`balance_transaction`表。
  6. 所有提现记录包含：申请人、审批人（房主）、金额、收款账户、凭证图片URL、时间戳。

#### **US-09 房主向平台充值托管额度**
- **作为** 房主
- **我希望** 通过向平台线下转账来提升我的 `owner_custody_quota`
- **以便** 有额度为玩家线上加款
- **验收标准**：
  1. 房主创建“托管额度充值”申请，上传线下转账凭证。
  2. 平台审核通过后，系统增加 `owner_custody_quota`，记录账本。
  3. 托管额度用于玩家充值的账务对冲，额度不可为负。

#### **US-10 房主保证金管理**
- **作为** 房主
- **我希望** 线下向平台缴纳/提取保证金
- **以便** 满足平台风控要求
- **验收标准**：
  1. 充值保证金：上传凭证 → 平台审核 → 增加 `owner_margin_balance`。
  2. 提取保证金：发起申请 → 平台审核风控阈值（如最低保证金、风险敞口覆盖）→ 减少 `owner_margin_balance`。

#### **US-11 房主提现（平台仅对接房主）**
- **作为** 房主
- **我希望** 将 `owner_withdrawable_balance` 的收益线下提现
- **以便** 提取我的收益
- **验收标准**：
  1. 发起提现申请，金额转入 `owner_frozen_balance`。
  2. 平台线下打款并上传凭证。
  3. 系统扣减 `owner_frozen_balance` 完成提现，并记录账本。

---

## **3. 技术要求和约束**

### **3.1 系统架构核心约束**

#### **3.1.0 技术栈选型**
1. **后端**：采用 **Go 语言** 开发，利用 Go 的高并发特性（goroutine + channel）实现 RoomProcessor 事件队列和 WebSocket 长连接管理，配合 Redis 做分布式锁和缓存，PostgreSQL/MySQL 做持久化存储。
2. **前端**：采用 **Flutter** 框架，一套代码同时发布 iOS 和 Android 双端，使用 Dart 语言编写，配合 `web_socket_channel` 实现实时通信，使用 Provider/Riverpod 进行状态管理。
3. **通信协议**：客户端与服务端通过 WebSocket (WSS) 进行实时双向通信，REST API 用于非实时操作（如登录、充值、提现）。

#### **3.1.1 房间状态机实现规范**
1. **实现模式**：采用 **“单房间单事件队列处理器”（RoomProcessor）** 模式。
   - 每个活跃房间对应一个`RoomProcessor`实例。
   - 实例维护一个**内存事件队列**，接收所有发往该房间的事件。
   - 处理器**串行**处理队列中的事件，确保每个事件的处理（条件检查、状态转换、持久化、广播）是原子的。
2. **状态转换防御性规则**：
   - 定义清晰的状态转换矩阵，非法转换应被忽略或返回错误。
   - 每次状态转换成功后，立即将完整的`state_json`持久化到数据库`rooms.state_json`字段。
3. **状态恢复**：服务重启时，`RoomProcessor`从数据库加载`state_json`恢复内存状态，并**从数据库拉取房间内所有玩家的最新余额**，刷新内存状态中的玩家数据。
4. **P0部署**：通过**强分布式锁**确保每个房间在任何时刻只有一个有效的`RoomProcessor`实例，规避分布式一致性问题。

#### **3.1.2 数据一致性规范**
1. **内存与数据库同步**：
   - **写后更新**：任何导致数据库余额变更的操作（结算、结转）**成功提交后**，必须立即更新`RoomProcessor`内存状态中对应的数据。
   - **读策略**：
     - 房间内其他玩家查看某玩家余额：**读取内存状态**。
     - 玩家查看自己总余额（个人中心）：**查询数据库**。
2. **余额缓存策略（P1预留）**：`users.balance_version`字段用于实现乐观锁。P0不启用缓存。

#### **3.1.3 事件驱动交互设计**

**事件流总览：**
```
客户端行为 -> WebSocket事件 -> RoomProcessor事件队列 -> 串行处理 -> 广播状态更新
```

**关键事件定义：**

| 事件名 | 方向 | 触发条件 | 载荷 | 目标 |
|--------|------|----------|------|------|
| `server_room_snapshot` | S->C | 玩家加入/重连 | 房间完整状态 | 单播给目标玩家 |
| `room_status_update` | S->C | 阶段切换/奖池变化/定时更新 | `{phase, time_left, pool_amount, round_id}` | 广播给全房间 |
| `phase_tick` | S->C | 每3秒定时触发 | `{phase, time_left, pool_amount, round_id}` (P0完整) | 广播给全房间 |
| `betting_completed` | S->C | 自动下注完成 | `{pool_amount, participant_count, skipped_users[]}` | 广播给全房间 |
| `settlement_result` | S->C | 结算完成 | `{winners[], prize_per_winner, round_id}` | 广播给全房间 |
| `system_alert` | S->C | 系统提示或错误 | `{level, message, duration_ms?}` | 广播给相关玩家 |

**前端校准算法**（收到`phase_tick`时）：
1. 计算偏差：`delta = 服务器时间_left - 本地计算时间_left`
2. 如果`|delta| < 2秒`，则微调本地计时器速度（如每秒补偿`delta/3`）
3. 如果`|delta| >= 2秒`，则立即将本地显示时间跳转为服务器时间

#### **3.1.4 游戏状态机详细规则**

**阶段定义与转换：**
1. **WAITING (等待中 / Waiting)**：
   - **进入条件**：房间创建后，或`RESET`阶段检查准备人数不达标时。
   - **可执行操作**：玩家准备/取消准备。
   - **转换触发**：当任何玩家的准备状态变为`true`且达标时，**立即**切换到`COUNTDOWN`。

2. **COUNTDOWN (倒计时 / Countdown)**：
   - **时长**：固定 **5秒**。
   - **中断机制**：当任何玩家的准备状态变为`false`导致不达标时，**立即**回退到`WAITING`。
   - **转换触发**：倒计时结束，自动进入`BETTING`。

3. **BETTING (下注中 / Betting)**：
   - **时长**：固定 **5秒**（包含自动扣款 + 短暂展示）。
   - **自动执行**：进入阶段时，系统立即按房间设定的固定金额扣除所有“自动准备”玩家的余额，余额不足者跳过。
   - **转换触发**：5秒后自动进入`IN_GAME`。

4. **IN_GAME (游戏中 / Playing)**：
   - **时长**：固定 **5秒**（动画展示）。
   - **可执行操作**：无。
   - **转换触发**：5秒后自动进入`SETTLEMENT`。

5. **SETTLEMENT (结算中 / Settlement)**：
   - **时长**：固定 **5秒**。
   - **可执行操作**：无。
   - **转换触发**：5秒后自动进入`RESET`。

6. **RESET (重置 / Reset)**：
   - **逻辑处理阶段**，无UI倒计时（瞬时完成）。
   - **职责**：
     - 清理上一轮数据（清空临时奖池）。
     - 检查当前“已准备玩家数”：
       - 若**仍达标**，则立即切换到`COUNTDOWN`。
       - 若**不达标**，则立即切换到`WAITING`。
   - **前端表现**：收到进入`RESET`的事件后，清除结算动画，等待下一个阶段事件。

#### **3.1.5 容量与性能目标（P0）**
- 单个房间最大玩家数：**100人**
- 单服务实例目标：支持不少于 **500个** 同时活跃的房间
- 核心操作响应时间 P95 < 200ms
- 状态同步延迟 P95 < 100ms
- 单个`RoomProcessor`在满负荷时，处理事件的平均延迟 < 50ms

#### **3.1.6 资金管理与账本设计（纯线下模式）**

**设计原则**：
- 不接入任何第三方线上支付/提现渠道
- 所有充值和提现均通过线下转账完成，线上只做申请和审批
- 所有资金变动必须有完整的账本记录，支持审计追溯

**账户体系**：
| 角色 | 账户字段 | 用途 |
|------|----------|------|
| 玩家 | `balance` | 可用余额，用于自动下注 |
| 玩家 | `frozen_balance` | 冻结余额（提现申请中） |
| 房主 | `owner_room_balance` | 房间内累积的抽成收益 |
| 房主 | `owner_withdrawable_balance` | 可提现余额（从房间收益结转） |
| 房主 | `owner_frozen_balance` | 冻结余额（提现申请中） |
| 房主 | `owner_custody_quota` | 房主对玩家的线上托管额度；玩家充值消耗额度，玩家提现回补额度 |
| 房主 | `owner_margin_balance` | 房主向平台缴纳的保证金，用于风险兜底与合规要求，不参与日常结算 |
| 平台 | `platform_balance` | 平台手续费收入（仅记录，不参与玩家代收代付） |

**平台只对接房主（托管关系）**：
- 平台不负责玩家的任何充值/提现现金流，线上仅记录玩家与房主的线下往来凭证。
- 平台与房主之间办理：房主充值托管额度、房主保证金充值/提取、房主自身提现。

**资金流转流程**：
1. **玩家充值（房主托管）**：
   - 玩家线下转账给房主 → 房主在后台创建“玩家充值”记录（金额+凭证）并审批通过 → 账务：`owner_custody_quota` 减少，同额增加玩家 `balance`。
2. **玩家提现（房主托管）**：
   - 玩家发起申请 → 系统冻结玩家 `balance` 到 `frozen_balance` → 房主线下打款 → 上传凭证并确认 → 账务：扣减玩家 `frozen_balance`，同额增加 `owner_custody_quota`。
3. **游戏结算（平台内虚拟账本）**：
   - 输家 `balance` 扣减 → 赢家 `balance` 增加（扣除费用）→ 房主 `owner_room_balance` 增加抽成 → 平台 `platform_balance` 增加手续费。
4. **房主收益结转**：
   - 房主发起结转 → `owner_room_balance` 转入 `owner_withdrawable_balance`。
5. **房主向平台充值托管额度**：
   - 房主线下向平台转账（或与平台线下结算）→ 平台审核 → 账务：增加 `owner_custody_quota`（用于后续给玩家加款）。
6. **房主保证金充值/提取**：
   - 充值：房主线下转账 → 平台审核 → 增加 `owner_margin_balance`；
   - 提取：房主申请 → 平台审核通过且满足风险约束 → 减少 `owner_margin_balance`。
7. **房主提现（平台仅对接房主）**：
   - 房主从 `owner_withdrawable_balance` 发起提现 → 系统冻结到 `owner_frozen_balance` → 平台线下打款 → 上传凭证 → 扣减 `owner_frozen_balance` 完成。

**账本表设计**（`balance_transaction`）：
| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | BIGINT | 主键，自增 |
| `tx_type` | ENUM | 类型：DEPOSIT/WITHDRAW/BET/WIN/LOSE/COMMISSION/PLATFORM_FEE/TRANSFER |
| `user_id` | BIGINT | 目标用户ID |
| `operator_id` | BIGINT | 操作人 ID（房主/平台管理员） |
| `room_id` | BIGINT | 关联房间（可为NULL） |
| `round_id` | BIGINT | 关联回合（可为NULL） |
| `amount` | DECIMAL(18,2) | 变动金额（正=加款，负=扣款） |
| `balance_before` | DECIMAL(18,2) | 操作前余额 |
| `balance_after` | DECIMAL(18,2) | 操作后余额 |
| `voucher_url` | VARCHAR(500) | 凭证图片URL（充值/提现必填） |
| `remark` | VARCHAR(500) | 备注 |
| `created_at` | TIMESTAMP | 创建时间 |

**充值/提现申请表**（`fund_request`）：
| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | BIGINT | 主键 |
| `request_type` | ENUM | DEPOSIT / WITHDRAW |
| `user_id` | BIGINT | 申请人 |
| `room_id` | BIGINT | 关联房间 |
| `amount` | DECIMAL(18,2) | 金额 |
| `status` | ENUM | PENDING / APPROVED / REJECTED / COMPLETED |
| `payment_account` | VARCHAR(200) | 收款账户信息（提现用） |
| `voucher_url` | VARCHAR(500) | 凭证图片 |
| `operator_id` | BIGINT | 审批人 |
| `created_at` | TIMESTAMP | 申请时间 |
| `updated_at` | TIMESTAMP | 更新时间 |

**平台级资金守恒**：
- 对于每一笔账务事件，定义恒等式：
  - 玩家相关事件：`Δ玩家余额 + Δ玩家冻结余额 + Δowner_custody_quota + Δowner_room/withdrawable/frozen + Δplatform_balance = 0`
  - 房主与平台事件（不含玩家）：`Δowner_custody_quota + Δowner_margin_balance + Δowner_withdrawable/frozen + Δplatform_balance = 0`
- 每日对账：按房主维度校验`Σ(名下玩家余额+冻结) + owner_room_balance + owner_withdrawable_balance + owner_frozen_balance`与`owner_custody_quota + owner_margin_balance`的关系，异常告警。

**审计与监管**：
- 所有账本记录不可删除、不可修改（只记录负数充正）
- 平台管理员可查看任意用户、房间、房主维度的完整账本流水
- 支持按时间、房间、房主、用户、类型筛选和导出
- 异常检测：余额为负、单笔超限、托管额度为负、频繁操作等自动告警

### **3.2 非功能性需求**

1. **可用性**：
   - 核心游戏服务月度可用性 >= 99.5%
   - 支付与账户服务月度可用性 >= 99.9%

2. **监控与告警（P0基础）**：
   - **必须监控**：
     - 数据库事务锁等待时间、死锁频率
     - `RoomProcessor`事件队列长度（告警阈值：持续>10达5秒）
     - 结算事务失败/重试率
     - WebSocket连接数、消息延迟
   - **关键业务指标**：
     - 在线房间数、同时在线玩家数
     - 每秒游戏开局数、日均流水

3. **数据一致性**：
   - 资金数据：强一致性（CP）
   - 游戏状态数据：通过串行化处理达到强一致性效果

---

## **4. 风险点和解决方案**

### **4.1 已识别风险与应对方案**

| 风险点 | 影响等级 | 应对方案 | 状态 |
|--------|----------|----------|------|
| **资金结算并发冲突** | 高 | 数据库事务 + 按`user_id`升序加锁 + 事务超时监控 | 已解决 |
| **游戏状态竞态条件** | 高 | `RoomProcessor`串行事件队列 + 原子状态转换 + 状态持久化 | 已解决 |
| **充值/提现凭证伪造** | 高 | 房主人工审核凭证 + 平台抽查审计 + 账本不可篡改 | 已解决 |
| **断线重连状态不一致** | 中 | 服务端状态权威 + 重连时单播完整快照 | 已解决 |
| **分布式环境脑裂** | 中 | P0采用强分布式锁保证单主机，规避问题 | 已解决 |
| **结算事务长时间挂起** | 中 | 事务超时设置 + 降级流程（错误状态+友好提示+告警重试） | 已解决 |
| **房主收益结转冲突** | 低 | 后端校验房间阶段（仅允许WAITING/RESET） | 已解决 |

### **4.2 残余风险与演进规划**

1. **`RoomProcessor`单点性能瓶颈**
   - **风险**：单个房间玩家极多或事件风暴时，串行处理器可能成为瓶颈。
   - **P0应对**：设定单房间100人上限，通过压力测试验证处理能力。
   - **P2演进**：将状态拆分为“核心状态机”（串行）和“只读数据”（并行同步）。

2. **结算事务重试的业务一致性**
   - **风险**：重试时外部状态变化可能导致结果与首次尝试不同。
   - **P0应对**：接受极低概率的微小不一致，通过告警+人工介入处理。
   - **P1优化**：实现业务幂等的重试，持久化“结算计划”供重试使用。

3. **网络包序导致状态不同步**
   - **风险**：`phase_tick`与`room_status_update`到达顺序可能乱序。
   - **P0应对**：`phase_tick`携带完整状态信息，确保前端信息自洽。
   - **P1优化**：优化事件设计，减少冗余数据。

---

## **5. 实施建议**

### **5.1 详细技术设计阶段产出物**
建议技术团队按顺序产出以下设计文档，产品经理参与评审：

1. **系统架构设计**
   - 系统上下文图、容器图
   - 部署拓扑草图（状态化RoomProcessor服务与无状态网关分离）

2. **核心模块详细设计**
   - `RoomProcessor`/状态机的详细类图、序列图
   - 事件队列实现选型（内存Channel/Redis Stream）
   - 数据库DDL（users, rooms, game_rounds, balance_transaction等）

3. **API与协议定义**
   - 完整的WebSocket/REST API文档
   - 所有事件Payload示例和错误码
   - 内部服务间（游戏->账户）接口定义

4. **关键流程交互设计**
   - 核心流程（加入、准备、自动下注、结算、重连）的时序图
   - 异常处理流程设计

### **5.2 开发与测试重点**

1. **第一阶段（核心闭环）**：
   - `RoomProcessor`基础框架与状态机
   - 资金结算事务与锁顺序实现
   - 基础事件通信与前端状态同步

2. **第二阶段（完整流程）**：
   - 完整的5阶段游戏循环
   - 断线重连恢复
   - 房主收益结转与提现流程

3. **第三阶段（打磨上线）**：
   - 支付集成与对账
   - 监控告警接入
   - 压力测试与性能调优

### **5.3 产品经理后续角色**
1. **设计评审参与**：作为业务规则和用户体验的最终解释者，参与各项技术设计评审。
2. **验收测试用例**：协同团队基于本PRD细化验收测试用例（ATC）。
3. **灵活协作**：对不违背核心原则与体验的技术实现微调保持开放，共同解决问题。

---

## **6. 附录：关键决策记录**

1. **状态机驱动方式**：从“条件轮询”改为 **“玩家准备事件驱动”**，确保实时性与原子性。
2. **状态同步策略**：`server_room_snapshot`**单播**给新加入/重连玩家；`room_status_update`**广播**轻量状态摘要。
3. **时间同步方案**：`phase_tick`每3秒作为**校准信号**，前端采用平滑校准算法。
4. **并发控制方案**：
   - 资金结算：数据库事务 + 固定锁顺序
   - 状态变更：串行事件队列
   - 收益结转：后端阶段校验
5. **P0简化决策**：
   - 通过强锁规避分布式一致性问题
   - `phase_tick`保持完整载荷避免包序问题
   - 接受重试可能导致的极低概率不一致

---

**文档签署：**
- 产品经理：___________ 日期：___________
- 技术负责人：___________ 日期：___________
- 项目负责人：___________ 日期：___________

**本PRD作为项目开发的基准文档，任何后续变更需经过正式变更流程。**
